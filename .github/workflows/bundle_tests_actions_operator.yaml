# Run bundle integration tests
# This workflow has been separated from integrate.yaml due to the verbosity
# of the steps, as we have to manually configure the operator environment.
# This is a workaround that should be changed when the charmed-kubernetes/actions-operator
# works correctly on self hosted runners.
# TODO: move this workflow to canonical/charmed-kubeflow-workflows
name: Bundle integration tests actions operator

on:
  workflow_call:

jobs:
  test-bundle:
    name: Bundle functional tests actions operator
    runs-on: [self-hosted, linux, X64, jammy, two-xlarge]
    timeout-minutes: 200
    steps:
      - uses: actions/checkout@v3
      - name: Setup operator environment
        uses: charmed-kubernetes/actions-operator@main
        with:
          provider: microk8s
          channel: 1.25-strict/stable
          juju-channel: 3.1/stable
          charmcraft-channel: latest/candidate
          microk8s-addons: "dns hostpath-storage rbac metallb:10.64.140.43-10.64.140.49"

      - name: Run test
        run: |
          # Requires the model to be called kubeflow due to kfp-viewer
          juju add-model kubeflow
          # Run integration tests against the 1.7 generic install bundle definition
          # Using destructive mode because of https://github.com/canonical/charmcraft/issues/1132
          # and https://github.com/canonical/charmcraft/issues/1138
          sg snap_microk8s -c "tox -e bundle-integration -- --model kubeflow --bundle=./tests/integration/bundles/kfp_1.7_stable_install.yaml.j2 --destructive-mode"
